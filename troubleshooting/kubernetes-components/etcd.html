<!doctype html>
<html class="docs-version-2.4.15" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Troubleshooting etcd Nodes | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://btat.github.io/rancher-docusaurus/troubleshooting/kubernetes-components/etcd"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="2.4.15"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-2.4.15"><meta data-react-helmet="true" property="og:title" content="Troubleshooting etcd Nodes | My Site"><meta data-react-helmet="true" name="description" content="This section contains commands and tips for troubleshooting nodes with the etcd role."><meta data-react-helmet="true" property="og:description" content="This section contains commands and tips for troubleshooting nodes with the etcd role."><link data-react-helmet="true" rel="shortcut icon" href="/rancher-docusaurus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://btat.github.io/rancher-docusaurus/troubleshooting/kubernetes-components/etcd"><link data-react-helmet="true" rel="alternate" href="https://btat.github.io/rancher-docusaurus/troubleshooting/kubernetes-components/etcd" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://btat.github.io/rancher-docusaurus/troubleshooting/kubernetes-components/etcd" hreflang="x-default"><link rel="stylesheet" href="/rancher-docusaurus/assets/css/styles.6d09dbb1.css">
<link rel="preload" href="/rancher-docusaurus/assets/js/runtime~main.e49194ca.js" as="script">
<link rel="preload" href="/rancher-docusaurus/assets/js/main.ed945e9c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rancher-docusaurus/"><img src="/rancher-docusaurus/img/rancher-logo.svg" alt="Rancher Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/rancher-docusaurus/img/rancher-logo.svg" alt="Rancher Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Rancher Docs</b></a><a href="https://suse-projects.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>More SUSE Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Rancher Deployment Quick Start Guides</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Installing/Upgrading Rancher</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Best Practices Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Backups and Disaster Recovery</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Authentication, Permissions and Global Configuration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Setting up Kubernetes Clusters in Rancher</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Cluster Administration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Project Administration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pipelines</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deploying Applications across Clusters</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Monitoring and Alerting</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Istio</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Logging</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">CIS Scans</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes Resources</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Security</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Settings</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">FAQ</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Troubleshooting</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/dns">DNS</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/imported-clusters">Registered clusters</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/index">Intro</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">kubernetes-components</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/kubernetes-components/controlplane">Troubleshooting Controlplane Nodes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rancher-docusaurus/troubleshooting/kubernetes-components/etcd">Troubleshooting etcd Nodes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/kubernetes-components/index">Kubernetes Components</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/kubernetes-components/nginx-proxy">Troubleshooting nginx-proxy</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/kubernetes-components/worker-and-generic">Troubleshooting Worker Nodes and Generic Components</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/kubernetes-resources">Kubernetes resources</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/logging">Logging</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/networking">Networking</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/rancherha">Rancher HA</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/troubleshooting/userid-tracking-in-audit-logs">User ID Tracking in Audit Logs</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/cli">Using the Rancher Command Line Interface</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/contributing">Contributing to Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/helm-charts">Helm Charts in Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/">Rancher 2.6</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/longhorn">Longhorn - Cloud native distributed block storage for Kubernetes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/opa-gatekeper">OPA Gatekeeper</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/system-tools">System Tools</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 2.4.15</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Troubleshooting etcd Nodes</h1></header><p>This section contains commands and tips for troubleshooting nodes with the <code>etcd</code> role.</p><header><h1>Checking if the etcd Container is Running</h1></header><p>The container for etcd should have status <strong>Up</strong>. The duration shown after <strong>Up</strong> is the time the container has been running.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker ps -a -f=name=etcd$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES</span></span><span class="token-line" style="color:#393A34"><span class="token plain">605a124503b9        rancher/coreos-etcd:v3.2.18   &quot;/usr/local/bin/et...&quot;   2 hours ago         Up 2 hours                              etcd</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>etcd Container Logging</h1></header><p>The logging of the container can contain information on what the problem could be.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker logs etcd</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><table><thead><tr><th>Log</th><th>Explanation</th></tr></thead><tbody><tr><td><code>health check for peer xxx could not connect: dial tcp IP:2380: getsockopt: connection refused</code></td><td>A connection to the address shown on port 2380 cannot be established. Check if the etcd container is running on the host with the address shown.</td></tr><tr><td><code>xxx is starting a new election at term x</code></td><td>The etcd cluster has lost its quorum and is trying to establish a new leader. This can happen when the majority of the nodes running etcd go down/unreachable.</td></tr><tr><td><code>connection error: desc = &quot;transport: Error while dialing dial tcp 0.0.0.0:2379: i/o timeout&quot;; Reconnecting to {0.0.0.0:2379 0  \&lt;nil\&gt;}</code></td><td>The host firewall is preventing network communication.</td></tr><tr><td><code>rafthttp: request cluster ID mismatch</code></td><td>The node with the etcd instance logging <code>rafthttp: request cluster ID mismatch</code> is trying to join a cluster that has already been formed with another peer. The node should be removed from the cluster, and re-added.</td></tr><tr><td><code>rafthttp: failed to find member</code></td><td>The cluster state (<code>/var/lib/etcd</code>) contains wrong information to join the cluster. The node should be removed from the cluster, the state directory should be cleaned and the node should be re-added.</td></tr></tbody></table><header><h1>etcd Cluster and Connectivity Checks</h1></header><p>The address where etcd is listening depends on the address configuration of the host etcd is running on. If an internal address is configured for the host etcd is running on, the endpoint for <code>etcdctl</code> needs to be specified explicitly. If any of the commands respond with <code>Error:  context deadline exceeded</code>, the etcd instance is unhealthy (either quorum is lost or the instance is not correctly joined in the cluster)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="check-etcd-members-on-all-nodes"></a>Check etcd Members on all Nodes<a class="hash-link" href="#check-etcd-members-on-all-nodes" title="Direct link to heading">#</a></h3><p>Output should contain all the nodes with the <code>etcd</code> role and the output should be identical on all nodes.</p><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl member list</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">xxx, started, etcd-xxx, https://IP:2380, https://IP:2379,https://IP:4001</span></span><span class="token-line" style="color:#393A34"><span class="token plain">xxx, started, etcd-xxx, https://IP:2380, https://IP:2379,https://IP:4001</span></span><span class="token-line" style="color:#393A34"><span class="token plain">xxx, started, etcd-xxx, https://IP:2380, https://IP:2379,https://IP:4001</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="check-endpoint-status"></a>Check Endpoint Status<a class="hash-link" href="#check-endpoint-status" title="Direct link to heading">#</a></h3><p>The values for <code>RAFT TERM</code> should be equal and <code>RAFT INDEX</code> should be not be too far apart from each other.</p><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -e ETCDCTL_ENDPOINTS=$(docker exec etcd /bin/sh -c &quot;etcdctl member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;) etcd etcdctl endpoint status --write-out table</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl endpoint status --endpoints=$(docker exec etcd /bin/sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;) --write-out table</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+------------------+---------+---------+-----------+-----------+------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+------------------+---------+---------+-----------+-----------+------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| https://IP:2379 | 333ef673fc4add56 |  3.2.18 |   24 MB |     false |        72 |      66887 |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| https://IP:2379 | 5feed52d940ce4cf |  3.2.18 |   24 MB |      true |        72 |      66887 |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| https://IP:2379 | db6b3bdb559a848d |  3.2.18 |   25 MB |     false |        72 |      66887 |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+------------------+---------+---------+-----------+-----------+------------+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="check-endpoint-health"></a>Check Endpoint Health<a class="hash-link" href="#check-endpoint-health" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -e ETCDCTL_ENDPOINTS=$(docker exec etcd /bin/sh -c &quot;etcdctl member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;) etcd etcdctl endpoint health</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl endpoint health --endpoints=$(docker exec etcd /bin/sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">https://IP:2379 is healthy: successfully committed proposal: took = 2.113189ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">https://IP:2379 is healthy: successfully committed proposal: took = 2.649963ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">https://IP:2379 is healthy: successfully committed proposal: took = 2.451201ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="check-connectivity-on-port-tcp2379"></a>Check Connectivity on Port TCP/2379<a class="hash-link" href="#check-connectivity-on-port-tcp2379" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">for endpoint in $(docker exec etcd /bin/sh -c &quot;etcdctl member list | cut -d, -f5&quot;); do</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   echo &quot;Validating connection to ${endpoint}/health&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl -s -w &quot;\n&quot; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) &quot;${endpoint}/health&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">for endpoint in $(docker exec etcd /bin/sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list | cut -d, -f5&quot;); do</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;Validating connection to ${endpoint}/health&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl -s -w &quot;\n&quot; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) &quot;${endpoint}/health&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Validating connection to https://IP:2379/health</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;health&quot;: &quot;true&quot;}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Validating connection to https://IP:2379/health</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;health&quot;: &quot;true&quot;}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Validating connection to https://IP:2379/health</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;health&quot;: &quot;true&quot;}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="check-connectivity-on-port-tcp2380"></a>Check Connectivity on Port TCP/2380<a class="hash-link" href="#check-connectivity-on-port-tcp2380" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">for endpoint in $(docker exec etcd /bin/sh -c &quot;etcdctl member list | cut -d, -f4&quot;); do</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;Validating connection to ${endpoint}/version&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl --http1.1 -s -w &quot;\n&quot; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) &quot;${endpoint}/version&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">for endpoint in $(docker exec etcd /bin/sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list | cut -d, -f4&quot;); do</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;Validating connection to ${endpoint}/version&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl --http1.1 -s -w &quot;\n&quot; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) &quot;${endpoint}/version&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Validating connection to https://IP:2380/version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;etcdserver&quot;:&quot;3.2.18&quot;,&quot;etcdcluster&quot;:&quot;3.2.0&quot;}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Validating connection to https://IP:2380/version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;etcdserver&quot;:&quot;3.2.18&quot;,&quot;etcdcluster&quot;:&quot;3.2.0&quot;}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Validating connection to https://IP:2380/version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;etcdserver&quot;:&quot;3.2.18&quot;,&quot;etcdcluster&quot;:&quot;3.2.0&quot;}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>etcd Alarms</h1></header><p>etcd will trigger alarms, for instance when it runs out of space.</p><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm list</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT alarm list&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output when NOSPACE alarm is triggered:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">memberID:x alarm:NOSPACE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">memberID:x alarm:NOSPACE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">memberID:x alarm:NOSPACE</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>etcd Space Errors</h1></header><p>Related error messages are <code>etcdserver: mvcc: database space exceeded</code> or <code>applying raft message exceeded backend quota</code>. Alarm <code>NOSPACE</code> will be triggered.</p><p>Resolutions:</p><ul><li><a href="#compact-the-keyspace">Compact the Keyspace</a></li><li><a href="#defrag-all-etcd-members">Defrag All etcd Members</a></li><li><a href="#check-endpoint-status">Check Endpoint Status</a></li><li><a href="#disarm-alarm">Disarm Alarm</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="compact-the-keyspace"></a>Compact the Keyspace<a class="hash-link" href="#compact-the-keyspace" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">rev=$(docker exec etcd etcdctl endpoint status --write-out json | egrep -o &#x27;&quot;revision&quot;:[0-9]*&#x27; | egrep -o &#x27;[0-9]*&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl compact &quot;$rev&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">rev=$(docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT endpoint status --write-out json | egrep -o &#x27;\&quot;revision\&quot;:[0-9]*&#x27; | egrep -o &#x27;[0-9]*&#x27;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT compact \&quot;$rev\&quot;&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">compacted revision xxx</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="defrag-all-etcd-members"></a>Defrag All etcd Members<a class="hash-link" href="#defrag-all-etcd-members" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -e ETCDCTL_ENDPOINTS=$(docker exec etcd /bin/sh -c &quot;etcdctl member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;) etcd etcdctl defrag</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl defrag --endpoints=$(docker exec etcd /bin/sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;)&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Finished defragmenting etcd member[https://IP:2379]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished defragmenting etcd member[https://IP:2379]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished defragmenting etcd member[https://IP:2379]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="check-endpoint-status-1"></a>Check Endpoint Status<a class="hash-link" href="#check-endpoint-status-1" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -e ETCDCTL_ENDPOINTS=$(docker exec etcd /bin/sh -c &quot;etcdctl member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;) etcd etcdctl endpoint status --write-out table</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl endpoint status --endpoints=$(docker exec etcd /bin/sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT member list | cut -d, -f5 | sed -e &#x27;s/ //g&#x27; | paste -sd &#x27;,&#x27;&quot;) --write-out table&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+------------------+---------+---------+-----------+-----------+------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+------------------+---------+---------+-----------+-----------+------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| https://IP:2379 |  e973e4419737125 |  3.2.18 |  553 kB |     false |        32 |    2449410 |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| https://IP:2379 | 4a509c997b26c206 |  3.2.18 |  553 kB |     false |        32 |    2449410 |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| https://IP:2379 | b217e736575e9dd3 |  3.2.18 |  553 kB |      true |        32 |    2449410 |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+------------------+---------+---------+-----------+-----------+------------+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="disarm-alarm"></a>Disarm Alarm<a class="hash-link" href="#disarm-alarm" title="Direct link to heading">#</a></h3><p>After verifying that the DB size went down after compaction and defragmenting, the alarm needs to be disarmed for etcd to allow writes again.</p><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm disarm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm list</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT alarm list&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT alarm disarm&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd sh -c &quot;etcdctl --endpoints=\$ETCDCTL_ENDPOINT alarm list&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">memberID:x alarm:NOSPACE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">memberID:x alarm:NOSPACE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">memberID:x alarm:NOSPACE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm disarm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl alarm list</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>Log Level</h1></header><p>The log level of etcd can be changed dynamically via the API. You can configure debug logging using the commands below.</p><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl -s -XPUT -d &#x27;{&quot;Level&quot;:&quot;DEBUG&quot;}&#x27; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) $(docker exec etcd printenv ETCDCTL_ENDPOINTS)/config/local/log</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl -s -XPUT -d &#x27;{&quot;Level&quot;:&quot;DEBUG&quot;}&#x27; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) $(docker exec etcd printenv ETCDCTL_ENDPOINT)/config/local/log</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To reset the log level back to the default (<code>INFO</code>), you can use the following command.</p><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl -s -XPUT -d &#x27;{&quot;Level&quot;:&quot;INFO&quot;}&#x27; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) $(docker exec etcd printenv ETCDCTL_ENDPOINTS)/config/local/log</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --net=host -v $(docker inspect kubelet --format &#x27;{{ range .Mounts }}{{ if eq .Destination &quot;/etc/kubernetes&quot; }}{{ .Source }}{{ end }}{{ end }}&#x27;)/ssl:/etc/kubernetes/ssl:ro appropriate/curl -s -XPUT -d &#x27;{&quot;Level&quot;:&quot;INFO&quot;}&#x27; --cacert $(docker exec etcd printenv ETCDCTL_CACERT) --cert $(docker exec etcd printenv ETCDCTL_CERT) --key $(docker exec etcd printenv ETCDCTL_KEY) $(docker exec etcd printenv ETCDCTL_ENDPOINT)/config/local/log</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>etcd Content</h1></header><p>If you want to investigate the contents of your etcd, you can either watch streaming events or you can query etcd directly, see below for examples.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="watch-streaming-events"></a>Watch Streaming Events<a class="hash-link" href="#watch-streaming-events" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl watch --prefix /registry</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl --endpoints=\$ETCDCTL_ENDPOINT watch --prefix /registry</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you only want to see the affected keys (and not the binary data), you can append <code>| grep -a ^/registry</code> to the command to filter for keys only.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="query-etcd-directly"></a>Query etcd Directly<a class="hash-link" href="#query-etcd-directly" title="Direct link to heading">#</a></h3><p>Command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl get /registry --prefix=true --keys-only</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Command when using etcd version lower than 3.3.x (Kubernetes 1.13.x and lower) and <code>--internal-address</code> was specified when adding the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl --endpoints=\$ETCDCTL_ENDPOINT get /registry --prefix=true --keys-only</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can process the data to get a summary of count per key, using the command below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec etcd etcdctl get /registry --prefix=true --keys-only | grep -v ^$ | awk -F&#x27;/&#x27; &#x27;{ if ($3 ~ /cattle.io/) {h[$3&quot;/&quot;$4]++} else { h[$3]++ }} END { for(k in h) print h[k], k }&#x27; | sort -nr</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>Replacing Unhealthy etcd Nodes</h1></header><p>When a node in your etcd cluster becomes unhealthy, the recommended approach is to fix or remove the failed or unhealthy node before adding a new etcd node to the cluster.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/main/website/versioned_docs/version-2.4.15/troubleshooting/kubernetes-components/etcd.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rancher-docusaurus/troubleshooting/kubernetes-components/controlplane"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Troubleshooting Controlplane Nodes</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/rancher-docusaurus/troubleshooting/kubernetes-components/index"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubernetes Components Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#check-etcd-members-on-all-nodes" class="table-of-contents__link">Check etcd Members on all Nodes</a></li><li><a href="#check-endpoint-status" class="table-of-contents__link">Check Endpoint Status</a></li><li><a href="#check-endpoint-health" class="table-of-contents__link">Check Endpoint Health</a></li><li><a href="#check-connectivity-on-port-tcp2379" class="table-of-contents__link">Check Connectivity on Port TCP/2379</a></li><li><a href="#check-connectivity-on-port-tcp2380" class="table-of-contents__link">Check Connectivity on Port TCP/2380</a></li><li><a href="#compact-the-keyspace" class="table-of-contents__link">Compact the Keyspace</a></li><li><a href="#defrag-all-etcd-members" class="table-of-contents__link">Defrag All etcd Members</a></li><li><a href="#check-endpoint-status-1" class="table-of-contents__link">Check Endpoint Status</a></li><li><a href="#disarm-alarm" class="table-of-contents__link">Disarm Alarm</a></li><li><a href="#watch-streaming-events" class="table-of-contents__link">Watch Streaming Events</a></li><li><a href="#query-etcd-directly" class="table-of-contents__link">Query etcd Directly</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://forums.rancher.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forums<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://slack.rancher.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Rancher_Labs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://rancher.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Rancher Website</a></li><li class="footer__item"><a href="https://github.com/rancher/rancher" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Rancher on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/rancher/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Rancher Docs on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/rancher-docusaurus/assets/js/runtime~main.e49194ca.js"></script>
<script src="/rancher-docusaurus/assets/js/main.ed945e9c.js"></script>
</body>
</html>