<!doctype html>
<html class="docs-version-2.5.9" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">How Monitoring Works | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://btat.github.io/rancher-docusaurus/2.5.9/monitoring-alerting/how-monitoring-works"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="2.5.9"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-2.5.9"><meta data-react-helmet="true" property="og:title" content="How Monitoring Works | My Site"><meta data-react-helmet="true" name="description" content="1. Architecture Overview"><meta data-react-helmet="true" property="og:description" content="1. Architecture Overview"><link data-react-helmet="true" rel="shortcut icon" href="/rancher-docusaurus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://btat.github.io/rancher-docusaurus/2.5.9/monitoring-alerting/how-monitoring-works"><link data-react-helmet="true" rel="alternate" href="https://btat.github.io/rancher-docusaurus/2.5.9/monitoring-alerting/how-monitoring-works" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://btat.github.io/rancher-docusaurus/2.5.9/monitoring-alerting/how-monitoring-works" hreflang="x-default"><link rel="stylesheet" href="/rancher-docusaurus/assets/css/styles.6d09dbb1.css">
<link rel="preload" href="/rancher-docusaurus/assets/js/runtime~main.e49194ca.js" as="script">
<link rel="preload" href="/rancher-docusaurus/assets/js/main.ed945e9c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rancher-docusaurus/"><img src="/rancher-docusaurus/img/rancher-logo.svg" alt="Rancher Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/rancher-docusaurus/img/rancher-logo.svg" alt="Rancher Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Rancher Docs</b></a><a href="https://suse-projects.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>More SUSE Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Rancher Deployment Quick Start Guides</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Installing/Upgrading Rancher</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Best Practices Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Backups and Disaster Recovery</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Authentication, Permissions and Global Configuration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Setting up Kubernetes Clusters in Rancher</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Cluster Administration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Project Administration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pipelines</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deploying Applications across Clusters</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Monitoring and Alerting</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">configuration</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/2.5.9/monitoring-alerting/dashboards">Built-in Dashboards</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/2.5.9/monitoring-alerting/expression">PromQL Expression Reference</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">guides</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rancher-docusaurus/2.5.9/monitoring-alerting/how-monitoring-works">How Monitoring Works</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/2.5.9/monitoring-alerting/index">Intro</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/2.5.9/monitoring-alerting/rbac">Role-based Access Control</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/2.5.9/monitoring-alerting/windows-clusters">Windows Cluster Support for Monitoring V2</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Istio</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Logging</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">CIS Scans</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes Resources</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Security</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Settings</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">FAQ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9/cli">Using the Rancher Command Line Interface</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9/contributing">Contributing to Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9/helm-charts">Helm Charts in Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9">Rancher 2.6</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9/longhorn">Longhorn - Cloud native distributed block storage for Kubernetes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9/opa-gatekeper">OPA Gatekeeper</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/2.5.9/system-tools">System Tools</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for My Site <b>2.5.9</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/rancher-docusaurus/monitoring-alerting/how-monitoring-works">latest version</a></b> (2.4.15).</div></div><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 2.5.9</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How Monitoring Works</h1></header><ol><li><a href="#1-architecture-overview">Architecture Overview</a></li><li><a href="#2-how-prometheus-works">How Prometheus Works</a></li><li><a href="#3-how-alertmanager-works">How Alertmanager Works</a></li><li><a href="#4-monitoring-v2-specific-components">Monitoring V2 Specific Components</a></li><li><a href="#5-scraping-and-exposing-metrics">Scraping and Exposing Metrics</a></li><li><a href="#6-monitoring-on-rke2-clusters">Monitoring on RKE2 Clusters</a></li></ol><header><h1>1. Architecture Overview</h1></header><p>This diagram shows how data flows through the Monitoring V2 application:</p><p>{{% row %}}
{{% column %}}</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly img"><pre tabindex="0" class="prism-code language-img codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">![How data flows through the monitoring application](./assets/img/rancher/monitoring-v2-architecture-overview.svg)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>{{% /column %}}
{{% column %}}</p><ol><li>Rules define what Prometheus metrics or time series database queries should result in alerts being fired.</li><li>ServiceMonitors and PodMonitors declaratively specify how services and pods should be monitored. They use labels to scrape metrics from pods.</li><li>Prometheus Operator observes ServiceMonitors, PodMonitors and PrometheusRules being created.</li><li>When the Prometheus configuration resources are created, Prometheus Operator calls the Prometheus API to sync the new configuration.</li><li>Recording Rules are not directly used for alerting. They create new time series of precomputed queries. These new time series data can then be queried to generate alerts.</li><li>Prometheus scrapes all targets in the scrape configuration on a recurring schedule based on the scrape interval, storing the results in its time series database.Depending on the Kubernetes master component and Kubernetes distribution, the metrics from a certain Kubernetes component could be directly exposed to Prometheus, proxied through PushProx, or not available. For details, see Scraping and Exposing Metrics.</li><li>Prometheus evaluates the alerting rules against the time series database. It fires alerts to Alertmanager whenever an alerting rule evaluates to a positive number.</li><li>Alertmanager uses routes to group, label and filter the fired alerts to translate them into useful notifications.</li><li>Alertmanager uses the  Receiver configuration to send notifications to Slack, PagerDuty, SMS, or other types of receivers.</li></ol><p>{{% /column %}}
{{% /row %}}</p><header><h1>2. How Prometheus Works</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="21-storing-time-series-data"></a>2.1. Storing Time Series Data<a class="hash-link" href="#21-storing-time-series-data" title="Direct link to heading">#</a></h3><p>After collecting metrics from exporters, Prometheus stores the time series in a local on-disk time series database. Prometheus optionally integrates with remote systems, but <code>rancher-monitoring</code> uses local storage for the time series database.</p><p>The database can then be queried using PromQL, the query language for Prometheus. Grafana dashboards use PromQL queries to generate data visualizations.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="22-querying-the-time-series-database"></a>2.2. Querying the Time Series Database<a class="hash-link" href="#22-querying-the-time-series-database" title="Direct link to heading">#</a></h3><p>The PromQL query language is the primary tool to query Prometheus for time series data.</p><p>In Grafana, you can right-click a CPU utilization and click Inspect. This opens a panel that shows the <a href="https://grafana.com/docs/grafana/latest/panels/inspect-panel/#inspect-raw-query-results" target="_blank" rel="noopener noreferrer">raw query results.</a>The raw results demonstrate how each dashboard is powered by PromQL queries.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="23-defining-rules-for-when-alerts-should-be-fired"></a>2.3. Defining Rules for when Alerts Should be Fired<a class="hash-link" href="#23-defining-rules-for-when-alerts-should-be-fired" title="Direct link to heading">#</a></h3><p>Rules define the conditions for Prometheus to fire alerts. When PrometheusRule custom resources are created or updated, the Prometheus Operator observes the change and calls the Prometheus API to synchronize the rule configuration with the Alerting Rules and Recording Rules in Prometheus.</p><p>When you define a Rule (which is declared within a RuleGroup in a PrometheusRule resource), the <a href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#rule" target="_blank" rel="noopener noreferrer">spec of the Rule itself</a> contains labels that are used by Alertmanager to figure out which Route should receive this Alert. For example, an Alert with the label <code>team: front-end</code> will be sent to all Routes that match on that label.</p><p>A PrometheusRule allows you to define one or more RuleGroups. Each RuleGroup consists of a set of Rule objects that can each represent either an alerting or a recording rule with the following fields:</p><ul><li>The name of the new alert or record</li><li>A PromQL expression for the new alert or record</li><li>Labels that should be attached to the alert or record that identify it (e.g. cluster name or severity)</li><li>Annotations that encode any additional important pieces of information that need to be displayed on the notification for an alert (e.g. summary, description, message, runbook URL, etc.). This field is not required for recording rules.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="24-firing-alerts"></a>2.4. Firing Alerts<a class="hash-link" href="#24-firing-alerts" title="Direct link to heading">#</a></h3><p>Prometheus doesn&#x27;t maintain the state of whether alerts are active. It fires alerts repetitively at every evaluation interval, relying on Alertmanager to group and filter the alerts into meaningful notifications.</p><p>The <code>evaluation_interval</code> constant defines how often Prometheus evaluates its alerting rules against the time series database. Similar to the <code>scrape_interval</code>, the <code>evaluation_interval</code> also defaults to one minute.</p><p>The rules are contained in a set of rule files. Rule files include both alerting rules and recording rules, but only alerting rules result in alerts being fired after their evaluation.</p><p>For recording rules, Prometheus runs a query, then stores it as a time series. This synthetic time series is useful for storing the results of an expensive or time-consuming query so that it can be queried more quickly in the future.</p><p>Alerting rules are more commonly used. Whenever an alerting rule evaluates to a positive number, Prometheus fires an alert.</p><p>The Rule file adds labels and annotations to alerts before firing them, depending on the use case:</p><ul><li>Labels indicate information that identifies the alert and could affect the routing of the alert. For example, if when sending an alert about a certain container, the container ID could be used as a label.</li><li>Annotations denote information that doesn&#x27;t affect where an alert is routed, for example, a runbook or an error message.</li></ul><header><h1>3. How Alertmanager Works</h1></header><p>The Alertmanager handles alerts sent by client applications such as the Prometheus server. It takes care of the following tasks:</p><ul><li>Deduplicating, grouping, and routing alerts to the correct receiver integration such as email, PagerDuty, or OpsGenie</li><li>Silencing and inhibition of alerts</li><li>Tracking alerts that fire over time</li><li>Sending out the status of whether an alert is currently firing, or if it is resolved
</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="31-routing-alerts-to-receivers"></a>3.1. Routing Alerts to Receivers<a class="hash-link" href="#31-routing-alerts-to-receivers" title="Direct link to heading">#</a></h3><p>Alertmanager coordinates where alerts are sent. It allows you to group alerts based on labels and fire them based on whether certain labels are matched. One top-level route accepts all alerts. From there, Alertmanager continues routing alerts to receivers based on whether they match the conditions of the next route.</p><p>While the Rancher UI forms only allow editing a routing tree that is two levels deep, you can configure more deeply nested routing structures by editing the Alertmanager custom resource YAML.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="32-configuring-multiple-receivers"></a>3.2. Configuring Multiple Receivers<a class="hash-link" href="#32-configuring-multiple-receivers" title="Direct link to heading">#</a></h3><p>By editing the forms in the Rancher UI, you can set up a Receiver resource with all the information Alertmanager needs to send alerts to your notification system.</p><p>By editing custom YAML in the Alertmanager or Receiver configuration, you can also send alerts to multiple notification systems. For more information, see the section on configuring <a href="/rancher-docusaurus/2.5.9/configuration/receiver#configuring-multiple-receivers">Receivers.</a></p><header><h1>4. Monitoring V2 Specific Components</h1></header><p>Prometheus Operator introduces a set of <a href="https://github.com/prometheus-operator/prometheus-operator#customresourcedefinitions" target="_blank" rel="noopener noreferrer">Custom Resource Definitions</a> that allow users to deploy and manage Prometheus and Alertmanager instances by creating and modifying those custom resources on a cluster.</p><p>Prometheus Operator will automatically update your Prometheus configuration based on the live state of the resources and configuration options that are edited in the Rancher UI.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="41-resources-deployed-by-default"></a>4.1. Resources Deployed by Default<a class="hash-link" href="#41-resources-deployed-by-default" title="Direct link to heading">#</a></h3><p>By default, a set of resources curated by the <a href="https://github.com/prometheus-operator/kube-prometheus" target="_blank" rel="noopener noreferrer">kube-prometheus</a> project are deployed onto your cluster as part of installing the Rancher Monitoring Application to set up a basic Monitoring/Alerting stack.</p><p>The resources that get deployed onto your cluster to support this solution can be found in the <a href="https://github.com/rancher/charts/tree/main/charts/rancher-monitoring" target="_blank" rel="noopener noreferrer"><code>rancher-monitoring</code></a> Helm chart, which closely tracks the upstream <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack" target="_blank" rel="noopener noreferrer">kube-prometheus-stack</a> Helm chart maintained by the Prometheus community with certain changes tracked in the <a href="https://github.com/rancher/charts/blob/main/charts/rancher-monitoring/CHANGELOG.md" target="_blank" rel="noopener noreferrer">CHANGELOG.md</a>.</p><p>There are also certain special types of ConfigMaps and Secrets such as those corresponding to Grafana Dashboards, Grafana Datasources, and Alertmanager Configs that will automatically update your Prometheus configuration via sidecar proxies that observe the live state of those resources within your cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="42-pushprox"></a>4.2. PushProx<a class="hash-link" href="#42-pushprox" title="Direct link to heading">#</a></h3><p>PushProx enhances the security of the monitoring application, allowing it to be installed on hardened Kubernetes clusters.</p><p>To expose Kubernetes metrics, PushProxes use a client proxy model to expose specific ports within default Kubernetes components. Node exporters expose metrics to PushProx through an outbound connection.</p><p>The proxy allows <code>rancher-monitoring</code> to scrape metrics from processes on the hostNetwork, such as the <code>kube-api-server</code>, without opening up node ports to inbound connections.</p><p>PushProx is a DaemonSet that listens for clients that seek to register. Once registered, it proxies scrape requests through the established connection. Then the client executes the request to etcd.</p><p>All of the default ServiceMonitors, such as <code>rancher-monitoring-kube-controller-manager</code>, are configured to hit the metrics endpoint of the client using this proxy.</p><p>For more details about how PushProx works, refer to <a href="#5-5-scraping-metrics-with-pushprox">Scraping Metrics with PushProx.</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="43-default-exporters"></a>4.3. Default Exporters<a class="hash-link" href="#43-default-exporters" title="Direct link to heading">#</a></h3><p><code>rancher-monitoring</code> deploys two exporters to expose metrics to prometheus: <code>node-exporter</code> and <code>windows-exporter</code>. Both are deployed as DaemonSets.</p><p><code>node-exporter</code> exports container, pod and node metrics for CPU and memory from each Linux node. <code>windows-exporter</code> does the same, but for Windows nodes.</p><p>For more information on <code>node-exporter</code>, refer to the <a href="https://prometheus.io/docs/guides/node-exporter/" target="_blank" rel="noopener noreferrer">upstream documentation.</a></p><p><a href="https://github.com/kubernetes/kube-state-metrics" target="_blank" rel="noopener noreferrer">kube-state-metrics</a> is also useful because it exports metrics for Kubernetes components.</p><header><h1>4.4. Components Exposed in the Rancher UI</h1></header><p>When the monitoring application is installed, you will be able to edit the following components in the Rancher UI:</p><table><thead><tr><th>Component</th><th>Type of Component</th><th>Purpose and Common Use Cases for Editing</th></tr></thead><tbody><tr><td>ServiceMonitor</td><td>Custom resource</td><td>Set up targets to scrape custom metrics from. Automatically updates the scrape configuration in the Prometheus custom resource.</td></tr><tr><td>PodMonitor</td><td>Custom resource</td><td>Set up targets to scrape custom metrics from. Automatically updates the scrape configuration in the Prometheus custom resource.</td></tr><tr><td>Receiver</td><td>Configuration block (part of Alertmanager)</td><td>Set up a notification system to receive alerts. Automatically updates the Alertmanager custom resource.</td></tr><tr><td>Route</td><td>Configuration block (part of Alertmanager)</td><td>Add identifying information to make alerts more meaningful and direct them to individual teams. Automatically updates the Alertmanager custom resource.</td></tr><tr><td>PrometheusRule</td><td>Custom resource</td><td>For more advanced use cases, you may want to define what Prometheus metrics or time series database queries should result in alerts being fired.  Automatically updates the Prometheus custom resource.</td></tr><tr><td>Alertmanager</td><td>Custom resource</td><td>Edit this custom resource only if you need more advanced configuration options beyond what the Rancher UI exposes in the Routes and Receivers sections. For example, you might want to edit this resource to add a routing tree with more than two levels.</td></tr><tr><td>Prometheus</td><td>Custom resource</td><td>Edit this custom resource only if you need more advanced configuration beyond what can be configured using  ServiceMonitors, PodMonitors, or <a href="/rancher-docusaurus/2.5.9/configuration/helm-chart-options">Rancher monitoring Helm chart options.</a></td></tr></tbody></table><header><h1>5. Scraping and Exposing Metrics</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="51-defining-what-metrics-are-scraped"></a>5.1. Defining what Metrics are Scraped<a class="hash-link" href="#51-defining-what-metrics-are-scraped" title="Direct link to heading">#</a></h3><p>ServiceMonitors define targets that are intended for Prometheus to scrape. The <a href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/design.md#prometheus" target="_blank" rel="noopener noreferrer">Prometheus custom resource tells</a> Prometheus which ServiceMonitors it should use to find out where to scrape metrics from.</p><p>The Prometheus Operator observes the ServiceMonitors. When it observes that ServiceMonitors are created or updated, it calls the Prometheus API to update the scrape configuration in the Prometheus custom resource and keep it in sync with the scrape configuration in the ServiceMonitors. This scrape configuration tells Prometheus which endpoints to scrape metrics from and how it will label the metrics from those endpoints.</p><p>Prometheus scrapes all of the metrics defined in its scrape configuration at every <code>scrape_interval</code>, which is one minute by default.</p><p>The scrape configuration can be viewed as part of the Prometheus custom resource that is exposed in the Rancher UI.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="52-how-the-prometheus-operator-sets-up-metrics-scraping"></a>5.2. How the Prometheus Operator Sets up Metrics Scraping<a class="hash-link" href="#52-how-the-prometheus-operator-sets-up-metrics-scraping" title="Direct link to heading">#</a></h3><p>The Prometheus Deployment or StatefulSet scrapes metrics, and the configuration of Prometheus is controlled by the Prometheus custom resources. The Prometheus Operator watches for Prometheus and Alertmanager resources, and when they are created, the Prometheus Operator creates a Deployment or StatefulSet for Prometheus or Alertmanager with the user-defined configuration.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly img"><pre tabindex="0" class="prism-code language-img codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;figcaption\&gt;How the Prometheus Operator Sets up Metrics Scraping\&lt;/figcaption\&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">![How the Prometheus Operator sets up metrics scraping](./assets/img/rancher/set-up-scraping.svg)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the Prometheus Operator observes ServiceMonitors, PodMonitors and PrometheusRules being created, it knows that the scrape configuration needs to be updated in Prometheus. It updates Prometheus by first updating the configuration and rules files in the volumes of Prometheus&#x27;s Deployment or StatefulSet. Then it calls the Prometheus API to sync the new configuration, resulting in the Prometheus Deployment or StatefulSet to be modified in place.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly img"><pre tabindex="0" class="prism-code language-img codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">![How the Prometheus Operator Updates Scrape Configuration](./assets/img/rancher/update-scrape-config.svg)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="53-how-kubernetes-component-metrics-are-exposed"></a>5.3. How Kubernetes Component Metrics are Exposed<a class="hash-link" href="#53-how-kubernetes-component-metrics-are-exposed" title="Direct link to heading">#</a></h3><p>Prometheus scrapes metrics from deployments known as <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener noreferrer">exporters,</a> which export the time series data in a format that Prometheus can ingest. In Prometheus, time series consist of streams of timestamped values belonging to the same metric and the same set of labeled dimensions.</p><p>To allow monitoring to be installed on hardened Kubernetes clusters, <code>rancher-monitoring</code> application proxies the communication between Prometheus and the exporter through PushProx for some Kubernetes master components.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="54-scraping-metrics-without-pushprox"></a>5.4. Scraping Metrics without PushProx<a class="hash-link" href="#54-scraping-metrics-without-pushprox" title="Direct link to heading">#</a></h3><p>The Kubernetes components that directly expose metrics to Prometheus are the following:</p><ul><li>kubelet</li><li>ingress-nginx*</li><li>coreDns/kubeDns</li><li>kube-api-server</li></ul><p>* For RKE and RKE2 clusters, ingress-nginx is deployed by default and treated as an internal Kubernetes component.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="55-scraping-metrics-with-pushprox"></a>5.5. Scraping Metrics with PushProx<a class="hash-link" href="#55-scraping-metrics-with-pushprox" title="Direct link to heading">#</a></h3><p>The purpose of this architecture is to allow us to scrape internal Kubernetes components without exposing those ports to inbound requests. As a result, Prometheus can scrape metrics across a network boundary.</p><p>The Kubernetes components that expose metrics to Prometheus through PushProx are the following:</p><ul><li>kube-controller-manager</li><li>kube-scheduler</li><li>etcd</li><li>kube-proxy</li></ul><p>For each PushProx exporter, we deploy one PushProx client onto all target nodes. For example, a PushProx client is deployed onto all controlplane nodes for kube-controller-manager, all etcd nodes for kube-etcd, and all nodes for kubelet. We deploy exactly one PushProx proxy per exporter.</p><p>The process for exporting metrics is as follows:</p><ol><li>The PushProx Client establishes an outbound connection with the PushProx Proxy.</li><li>The client then polls the proxy for scrape requests that have come into the proxy.</li><li>When the proxy receives a scrape request from Prometheus, the client sees it as a result of the poll.</li><li>The client scrapes the internal component.</li><li>The internal component responds by pushing metrics back to the proxy.</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly img"><pre tabindex="0" class="prism-code language-img codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;figcaption\&gt;Process for Exporting Metrics with PushProx\&lt;/figcaption\&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">![Process for Exporting Metrics with PushProx](./assets/img/rancher/pushprox-process.svg)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Metrics are scraped differently based on the Kubernetes distribution. For help with terminology, see Terminology(#terminology). For details, see the table below:</p><p>\&lt;figcaption&gt;How Metrics are Exposed to Prometheus\&lt;/figcaption&gt;</p><table><thead><tr><th>Kubernetes Component</th><th>RKE</th><th>RKE2</th><th>KubeADM</th><th>K3s</th></tr></thead><tbody><tr><td>kube-controller-manager</td><td>rkeControllerManager.enabled</td><td>rke2ControllerManager.enabled</td><td>kubeAdmControllerManager.enabled</td><td>k3sServer.enabled</td></tr><tr><td>kube-scheduler</td><td>rkeScheduler.enabled</td><td>rke2Scheduler.enabled</td><td>kubeAdmScheduler.enabled</td><td>k3sServer.enabled</td></tr><tr><td>etcd</td><td>rkeEtcd.enabled</td><td>rke2Etcd.enabled</td><td>kubeAdmEtcd.enabled</td><td>Not available</td></tr><tr><td>kube-proxy</td><td>rkeProxy.enabled</td><td>rke2Proxy.enabled</td><td>kubeAdmProxy.enabled</td><td>k3sServer.enabled</td></tr><tr><td>kubelet</td><td>Collects metrics directly exposed by kubelet</td><td>Collects metrics directly exposed by kubelet</td><td>Collects metrics directly exposed by kubelet</td><td>Collects metrics directly exposed by kubelet</td></tr><tr><td>ingress-nginx*</td><td>Collects metrics directly exposed by kubelet, exposed by rkeIngressNginx.enabled</td><td>Collects metrics directly exposed by kubelet, Exposed by rke2IngressNginx.enabled</td><td>Not available</td><td>Not available</td></tr><tr><td>coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td><td>Collects metrics directly exposed by coreDns/kubeDns</td></tr><tr><td>kube-api-server</td><td>Collects metrics directly exposed by kube-api-server</td><td>Collects metrics directly exposed by kube-api-server</td><td>Collects metrics directly exposed by kube-appi-server</td><td>Collects metrics directly exposed by kube-api-server</td></tr></tbody></table><p>* For RKE and RKE2 clusters, ingress-nginx is deployed by default and treated as an internal Kubernetes component.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="56-terminology"></a>5.6. Terminology<a class="hash-link" href="#56-terminology" title="Direct link to heading">#</a></h3><ul><li><strong>kube-scheduler:</strong> The internal Kubernetes component that uses information in the pod spec to decide on which node to run a pod.</li><li><strong>kube-controller-manager:</strong> The internal Kubernetes component that is responsible for node management (detecting if a node fails), pod replication and endpoint creation.</li><li><strong>etcd:</strong> The internal Kubernetes component that is the distributed key/value store which Kubernetes uses for persistent storage of all cluster information.</li><li><strong>kube-proxy:</strong> The internal Kubernetes component that watches the API server for pods/services changes in order to maintain the network up to date.</li><li><strong>kubelet:</strong> The internal Kubernetes component that watches the API server for pods on a node and makes sure they are running.</li><li><strong>ingress-nginx:</strong> An Ingress controller for Kubernetes using NGINX as a reverse proxy and load balancer.</li><li><strong>coreDns/kubeDns:</strong> The internal Kubernetes component responsible for DNS.</li><li><strong>kube-api-server:</strong> The main internal Kubernetes component that is responsible for exposing APIs for the other master components.</li></ul><header><h1>6. Monitoring on RKE2 Clusters</h1></header><p>Rancher v2.6 introduced the ability to provision new Kubernetes clusters with <a href="https://docs.rke2.io/" target="_blank" rel="noopener noreferrer">RKE2,</a> which is Rancher&#x27;s fully conformant Kubernetes distribution that focuses on security and compliance within the U.S. Federal Government sector. To allow Monitoring V2 to be installed on RKE2 Kubernetes clusters, the <code>rkeIngressNginx</code> and <code>rke2IngressNginx</code> sub-charts were introduced to scrape metrics from the <code>ingress-nginx</code> Deployment/DaemonSet in RKE and RKE2 clusters respectively.</p><p>The PushProx pod needs to run on the same nodes as the <code>ingress-nginx</code> pod.</p><p>When the RKE2 cluster&#x27;s Kubernetes version is \&lt;= 1.20,  the workload type of <code>ingress-nginx</code> is a Deployment. The <code>pushprox-ingress-nginx-client</code> is deployed as a Deployment, and the Rancher UI sets the Helm chart value <code>rke2IngressNginx.deployment.enabled=true</code>.</p><p>For Kubernetes &gt;= 1.21, the workload type of <code>ingress-nginx</code> is a DaemonSet. The <code>pushprox-ingress-nginx-client</code> is deployed as a DaemonSet, which is the default behavior.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/main/website/versioned_docs/version-2.5.9/monitoring-alerting/how-monitoring-works.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rancher-docusaurus/2.5.9/monitoring-alerting/guides/uninstall"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Uninstall Monitoring</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/rancher-docusaurus/2.5.9/monitoring-alerting/index"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Intro Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#21-storing-time-series-data" class="table-of-contents__link">2.1. Storing Time Series Data</a></li><li><a href="#22-querying-the-time-series-database" class="table-of-contents__link">2.2. Querying the Time Series Database</a></li><li><a href="#23-defining-rules-for-when-alerts-should-be-fired" class="table-of-contents__link">2.3. Defining Rules for when Alerts Should be Fired</a></li><li><a href="#24-firing-alerts" class="table-of-contents__link">2.4. Firing Alerts</a></li><li><a href="#31-routing-alerts-to-receivers" class="table-of-contents__link">3.1. Routing Alerts to Receivers</a></li><li><a href="#32-configuring-multiple-receivers" class="table-of-contents__link">3.2. Configuring Multiple Receivers</a></li><li><a href="#41-resources-deployed-by-default" class="table-of-contents__link">4.1. Resources Deployed by Default</a></li><li><a href="#42-pushprox" class="table-of-contents__link">4.2. PushProx</a></li><li><a href="#43-default-exporters" class="table-of-contents__link">4.3. Default Exporters</a></li><li><a href="#51-defining-what-metrics-are-scraped" class="table-of-contents__link">5.1. Defining what Metrics are Scraped</a></li><li><a href="#52-how-the-prometheus-operator-sets-up-metrics-scraping" class="table-of-contents__link">5.2. How the Prometheus Operator Sets up Metrics Scraping</a></li><li><a href="#53-how-kubernetes-component-metrics-are-exposed" class="table-of-contents__link">5.3. How Kubernetes Component Metrics are Exposed</a></li><li><a href="#54-scraping-metrics-without-pushprox" class="table-of-contents__link">5.4. Scraping Metrics without PushProx</a></li><li><a href="#55-scraping-metrics-with-pushprox" class="table-of-contents__link">5.5. Scraping Metrics with PushProx</a></li><li><a href="#56-terminology" class="table-of-contents__link">5.6. Terminology</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://forums.rancher.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forums<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://slack.rancher.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Rancher_Labs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://rancher.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Rancher Website</a></li><li class="footer__item"><a href="https://github.com/rancher/rancher" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Rancher on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/rancher/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Rancher Docs on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/rancher-docusaurus/assets/js/runtime~main.e49194ca.js"></script>
<script src="/rancher-docusaurus/assets/js/main.ed945e9c.js"></script>
</body>
</html>