<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Removing Kubernetes Components from Nodes | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://btat.github.io/rancher-docusaurus/cluster-admin/cleaning-cluster-nodes"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Removing Kubernetes Components from Nodes | My Site"><meta data-react-helmet="true" name="description" content="Learn about cluster cleanup when removing nodes from your Rancher-launched Kubernetes cluster. What is removed, how to do it manually"><meta data-react-helmet="true" property="og:description" content="Learn about cluster cleanup when removing nodes from your Rancher-launched Kubernetes cluster. What is removed, how to do it manually"><link data-react-helmet="true" rel="shortcut icon" href="/rancher-docusaurus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://btat.github.io/rancher-docusaurus/cluster-admin/cleaning-cluster-nodes"><link data-react-helmet="true" rel="alternate" href="https://btat.github.io/rancher-docusaurus/cluster-admin/cleaning-cluster-nodes" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://btat.github.io/rancher-docusaurus/cluster-admin/cleaning-cluster-nodes" hreflang="x-default"><link rel="stylesheet" href="/rancher-docusaurus/assets/css/styles.6d09dbb1.css">
<link rel="preload" href="/rancher-docusaurus/assets/js/runtime~main.9668cced.js" as="script">
<link rel="preload" href="/rancher-docusaurus/assets/js/main.7243044c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/rancher-docusaurus/"><img src="/rancher-docusaurus/img/rancher-logo.svg" alt="Rancher Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/rancher-docusaurus/img/rancher-logo.svg" alt="Rancher Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Rancher Docs</b></a><a href="https://suse-projects.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>More SUSE Projects<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Rancher Deployment Quick Start Guides</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Installing/Upgrading Rancher</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Best Practices Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Backups and Disaster Recovery</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Authentication, Permissions and Global Configuration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Setting up Kubernetes Clusters in Rancher</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Cluster Administration</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/backing-up-etcd">Backing up a Cluster</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/certificate-rotation">Certificate Rotation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rancher-docusaurus/cluster-admin/cleaning-cluster-nodes">Removing Kubernetes Components from Nodes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/cloning-clusters">Cloning Clusters</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">cluster-access</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">cluster-autoscaler</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">editing-clusters</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/index">Intro</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/nodes">Nodes and Node Pools</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/pod-security-policies">Assigning Pod Security Policies</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/pod-security-policy">Adding a Pod Security Policy</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/projects-and-namespaces">Projects and Kubernetes Namespaces with Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/restoring-etcd">Restoring a Cluster from Backup</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/tools">Tools for Logging, Monitoring, and Visibility</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/rancher-docusaurus/cluster-admin/upgrading-kubernetes">Upgrading and Rolling Back Kubernetes</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">volumes-and-storage</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Project Administration</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Pipelines</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deploying Applications across Clusters</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Monitoring and Alerting</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Istio</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Logging</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">CIS Scans</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes Resources</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Security</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Settings</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">FAQ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/cli">Using the Rancher Command Line Interface</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/contributing">Contributing to Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/helm-charts">Helm Charts in Rancher</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/">Rancher 2.6</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/longhorn">Longhorn - Cloud native distributed block storage for Kubernetes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/opa-gatekeper">OPA Gatekeeper</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/rancher-docusaurus/system-tools">System Tools</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Removing Kubernetes Components from Nodes</h1></header><p>This section describes how to disconnect a node from a Rancher-launched Kubernetes cluster and remove all of the Kubernetes components from the node. This process allows you to use the node for other purposes.</p><p>When you use Rancher to install Kubernetes on new nodes in an infrastructure provider, resources (containers/virtual network interfaces) and configuration items (certificates/configuration files) are created.</p><p>When removing nodes from your Rancher launched Kubernetes cluster (provided that they are in <code>Active</code> state), those resources are automatically cleaned, and the only action needed is to restart the node. When a node has become unreachable and the automatic cleanup process cannot be used, we describe the steps that need to be executed before the node can be added to a cluster again.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="what-gets-removed"></a>What Gets Removed?<a class="hash-link" href="#what-gets-removed" title="Direct link to heading">#</a></h2><p>When cleaning nodes provisioned using Rancher, the following components are deleted based on the type of cluster node you&#x27;re removing.</p><table><thead><tr><th>Removed Component</th><th><a href="https://rancher.com/docs/rancher/v2.6/en/cluster-provisioning/rke-clusters/node-pools/" target="_blank" rel="noopener noreferrer">Nodes Hosted by Infrastructure Provider</a></th><th><a href="https://rancher.com/docs/rancher/v2.6/en/cluster-provisioning/rke-clusters/custom-nodes/" target="_blank" rel="noopener noreferrer">Custom Nodes</a></th><th><a href="https://rancher.com/docs/rancher/v2.6/en/cluster-provisioning/hosted-kubernetes-clusters/" target="_blank" rel="noopener noreferrer">Hosted Cluster</a></th><th><a href="https://rancher.com/docs/rancher/v2.6/en/cluster-provisioning/registered-clusters/" target="_blank" rel="noopener noreferrer">Registered Nodes</a></th></tr></thead><tbody><tr><td>The Rancher deployment namespace (<code>cattle-system</code> by default)</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td>âœ“</td></tr><tr><td><code>serviceAccount</code>, <code>clusterRoles</code>, and <code>clusterRoleBindings</code> labeled by Rancher</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td>âœ“</td></tr><tr><td>Labels, Annotations, and Finalizers</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td>âœ“</td></tr><tr><td>Rancher Deployment</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td></td></tr><tr><td>Machines, clusters, projects, and user custom resource definitions (CRDs)</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td></td></tr><tr><td>All resources create under the <code>management.cattle.io</code> API Group</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td></td></tr><tr><td>All CRDs created by Rancher v2.x</td><td>âœ“</td><td>âœ“</td><td>âœ“</td><td></td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="removing-a-node-from-a-cluster-by-rancher-ui"></a>Removing a Node from a Cluster by Rancher UI<a class="hash-link" href="#removing-a-node-from-a-cluster-by-rancher-ui" title="Direct link to heading">#</a></h2><p>When the node is in <code>Active</code> state, removing the node from a cluster will trigger a process to clean up the node. Please restart the node after the automatic cleanup process is done to make sure any non-persistent data is properly removed.</p><p><strong>To restart a node:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># using reboot</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo reboot</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># using shutdown</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo shutdown -r now</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="removing-rancher-components-from-a-cluster-manually"></a>Removing Rancher Components from a Cluster Manually<a class="hash-link" href="#removing-rancher-components-from-a-cluster-manually" title="Direct link to heading">#</a></h2><p>When a node is unreachable and removed from the cluster, the automatic cleaning process can&#x27;t be triggered because the node is unreachable. Please follow the steps below to manually remove the Rancher components.</p><p>&gt;<strong>Warning:</strong> The commands listed below will remove data from the node. Make sure you have created a backup of files you want to keep before executing any of the commands as data will be lost.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="removing-rancher-components-from-registered-clusters"></a>Removing Rancher Components from Registered Clusters<a class="hash-link" href="#removing-rancher-components-from-registered-clusters" title="Direct link to heading">#</a></h3><p>For registered clusters, the process for removing Rancher is a little different. You have the option of simply deleting the cluster in the Rancher UI, or your can run a script that removes Rancher components from the nodes. Both options make the same deletions.</p><p>After the registered cluster is detached from Rancher, the cluster&#x27;s workloads will be unaffected and you can access the cluster using the same methods that you did before the cluster was registered into Rancher.</p><p>{{% tabs %}}
{{% tab &quot;By UI / API&quot; %}}
&gt;<strong>Warning:</strong> This process will remove data from your cluster. Make sure you have created a backup of files you want to keep before executing the command, as data will be lost.</p><p>After you initiate the removal of a registered cluster using the Rancher UI (or API), the following events occur.</p><ol><li><p>Rancher creates a <code>serviceAccount</code> that it uses to remove the Rancher components from the cluster. This account is assigned the <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole" target="_blank" rel="noopener noreferrer">clusterRole</a> and <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding" target="_blank" rel="noopener noreferrer">clusterRoleBinding</a> permissions, which are required to remove the Rancher components.</p></li><li><p>Using the <code>serviceAccount</code>, Rancher schedules and runs a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" target="_blank" rel="noopener noreferrer">job</a> that cleans the Rancher components off of the cluster. This job also references the <code>serviceAccount</code> and its roles as dependencies, so the job deletes them before its completion.</p></li><li><p>Rancher is removed from the cluster. However, the cluster persists, running the native version of Kubernetes.</p></li></ol><p><strong>Result:</strong> All components listed for registered clusters in <a href="#what-gets-removed">What Gets Removed?</a> are deleted.</p><p>{{% /tab %}}
{{% tab &quot;By Script&quot; %}}
Rather than cleaning registered cluster nodes using the Rancher UI, you can run a script instead.</p><p>&gt;<strong>Prerequisite:</strong>
&gt;
&gt;Install <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a>.</p><ol><li><p>Open a web browser, navigate to <a href="https://github.com/rancher/rancher/blob/master/cleanup/user-cluster.sh" target="_blank" rel="noopener noreferrer">GitHub</a>, and download <code>user-cluster.sh</code>.</p></li><li><p>Make the script executable by running the following command from the same directory as <code>user-cluster.sh</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x user-cluster.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p><strong>Air Gap Environments Only:</strong> Open <code>user-cluster.sh</code> and replace <code>yaml_url</code> with the URL in <code>user-cluster.yml</code>.</p><p>If you don&#x27;t have an air gap environment, skip this step.</p></li><li><p>From the same directory, run the script and provide the <code>rancher/rancher-agent</code> image version which should be equal to the version of Rancher used to manage the cluster. (<code>[RANCHER_VERSION]</code>):</p><p>&gt;<strong>Tip:</strong>
&gt;
&gt;Add the <code>-dry-run</code> flag to preview the script&#x27;s outcome without making changes.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./user-cluster.sh rancher/rancher-agent:[RANCHER_VERSION]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><p><strong>Result:</strong> The script runs. All components listed for registered clusters in <a href="#what-gets-removed">What Gets Removed?</a> are deleted.</p><p>{{% /tab %}}
{{% /tabs %}}</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="windows-nodes"></a>Windows Nodes<a class="hash-link" href="#windows-nodes" title="Direct link to heading">#</a></h3><p>To clean up a Windows node, you can run a cleanup script located in <code>c:\etc\rancher</code>. The script deletes Kubernetes generated resources and the execution binary. It also drops the firewall rules and network settings.</p><p>To run the script, you can use this command in the PowerShell:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pushd c:\etc\rancher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">.\cleanup.ps1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Result:</strong> The node is reset and can be re-added to a Kubernetes cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="docker-containers-images-and-volumes"></a>Docker Containers, Images, and Volumes<a class="hash-link" href="#docker-containers-images-and-volumes" title="Direct link to heading">#</a></h3><p>Based on what role you assigned to the node, there are Kubernetes components in containers, containers belonging to overlay networking, DNS, ingress controller and Rancher agent. (and pods you created that have been scheduled to this node)</p><p><strong>To clean all Docker containers, images and volumes:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker rm -f $(docker ps -qa)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker rmi -f $(docker images -q)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker volume rm $(docker volume ls -q)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="mounts"></a>Mounts<a class="hash-link" href="#mounts" title="Direct link to heading">#</a></h3><p>Kubernetes components and secrets leave behind mounts on the system that need to be unmounted.</p><table><thead><tr><th>Mounts</th></tr></thead><tbody><tr><td><code>/var/lib/kubelet/pods/XXX</code> (miscellaneous mounts)</td></tr><tr><td><code>/var/lib/kubelet</code></td></tr><tr><td><code>/var/lib/rancher</code></td></tr></tbody></table><p><strong>To unmount all mounts:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">for mount in $(mount | grep tmpfs | grep &#x27;/var/lib/kubelet&#x27; | awk &#x27;{ print $3 }&#x27;) /var/lib/kubelet /var/lib/rancher; do umount $mount; done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="directories-and-files"></a>Directories and Files<a class="hash-link" href="#directories-and-files" title="Direct link to heading">#</a></h3><p>The following directories are used when adding a node to a cluster, and should be removed. You can remove a directory using <code>rm -rf /directory_name</code>.</p><p>&gt;<strong>Note:</strong> Depending on the role you assigned to the node, some of the directories will or won&#x27;t be present on the node.</p><table><thead><tr><th>Directories</th></tr></thead><tbody><tr><td><code>/etc/ceph</code></td></tr><tr><td><code>/etc/cni</code></td></tr><tr><td><code>/etc/kubernetes</code></td></tr><tr><td><code>/opt/cni</code></td></tr><tr><td><code>/opt/rke</code></td></tr><tr><td><code>/run/secrets/kubernetes.io</code></td></tr><tr><td><code>/run/calico</code></td></tr><tr><td><code>/run/flannel</code></td></tr><tr><td><code>/var/lib/calico</code></td></tr><tr><td><code>/var/lib/etcd</code></td></tr><tr><td><code>/var/lib/cni</code></td></tr><tr><td><code>/var/lib/kubelet</code></td></tr><tr><td><code>/var/lib/rancher/rke/log</code></td></tr><tr><td><code>/var/log/containers</code></td></tr><tr><td><code>/var/log/kube-audit</code></td></tr><tr><td><code>/var/log/pods</code></td></tr><tr><td><code>/var/run/calico</code></td></tr></tbody></table><p><strong>To clean the directories:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf /etc/ceph \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /etc/cni \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /etc/kubernetes \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /opt/cni \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /opt/rke \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /run/secrets/kubernetes.io \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /run/calico \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /run/flannel \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/lib/calico \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/lib/etcd \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/lib/cni \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/lib/kubelet \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/lib/rancher/rke/log \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/log/containers \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/log/kube-audit \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/log/pods \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       /var/run/calico</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="network-interfaces-and-iptables"></a>Network Interfaces and Iptables<a class="hash-link" href="#network-interfaces-and-iptables" title="Direct link to heading">#</a></h3><p>The remaining two components that are changed/configured are (virtual) network interfaces and iptables rules. Both are non-persistent to the node, meaning that they will be cleared after a restart of the node. To remove these components, a restart is recommended.</p><p><strong>To restart a node:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># using reboot</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo reboot</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># using shutdown</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo shutdown -r now</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you want to know more on (virtual) network interfaces or iptables rules, please see the specific subjects below.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="network-interfaces"></a>Network Interfaces<a class="hash-link" href="#network-interfaces" title="Direct link to heading">#</a></h3><p>&gt;<strong>Note:</strong> Depending on the network provider configured for the cluster the node was part of, some of the interfaces will or won&#x27;t be present on the node.</p><table><thead><tr><th>Interfaces</th></tr></thead><tbody><tr><td><code>flannel.1</code></td></tr><tr><td><code>cni0</code></td></tr><tr><td><code>tunl0</code></td></tr><tr><td><code>caliXXXXXXXXXXX</code> (random interface names)</td></tr><tr><td><code>vethXXXXXXXX</code> (random interface names)</td></tr></tbody></table><p><strong>To list all interfaces:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># Using ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ip address show</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># Using ifconfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig -a</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>To remove an interface:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">ip link delete interface_name</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="iptables"></a>Iptables<a class="hash-link" href="#iptables" title="Direct link to heading">#</a></h3><p>&gt;<strong>Note:</strong> Depending on the network provider configured for the cluster the node was part of, some of the chains will or won&#x27;t be present on the node.</p><p>Iptables rules are used to route traffic from and to containers. The created rules are not persistent, so restarting the node will restore iptables to its original state.</p><table><thead><tr><th>Chains</th></tr></thead><tbody><tr><td><code>cali-failsafe-in</code></td></tr><tr><td><code>cali-failsafe-out</code></td></tr><tr><td><code>cali-fip-dnat</code></td></tr><tr><td><code>cali-fip-snat</code></td></tr><tr><td><code>cali-from-hep-forward</code></td></tr><tr><td><code>cali-from-host-endpoint</code></td></tr><tr><td><code>cali-from-wl-dispatch</code></td></tr><tr><td><code>cali-fw-caliXXXXXXXXXXX</code> (random chain names)</td></tr><tr><td><code>cali-nat-outgoing</code></td></tr><tr><td><code>cali-pri-kns.NAMESPACE</code> (chain per namespace)</td></tr><tr><td><code>cali-pro-kns.NAMESPACE</code> (chain per namespace)</td></tr><tr><td><code>cali-to-hep-forward</code></td></tr><tr><td><code>cali-to-host-endpoint</code></td></tr><tr><td><code>cali-to-wl-dispatch</code></td></tr><tr><td><code>cali-tw-caliXXXXXXXXXXX</code> (random chain names)</td></tr><tr><td><code>cali-wl-to-host</code></td></tr><tr><td><code>KUBE-EXTERNAL-SERVICES</code></td></tr><tr><td><code>KUBE-FIREWALL</code></td></tr><tr><td><code>KUBE-MARK-DROP</code></td></tr><tr><td><code>KUBE-MARK-MASQ</code></td></tr><tr><td><code>KUBE-NODEPORTS</code></td></tr><tr><td><code>KUBE-SEP-XXXXXXXXXXXXXXXX</code> (random chain names)</td></tr><tr><td><code>KUBE-SERVICES</code></td></tr><tr><td><code>KUBE-SVC-XXXXXXXXXXXXXXXX</code> (random chain names)</td></tr></tbody></table><p><strong>To list all iptables rules:</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">iptables -L -t nat</span></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -L -t mangle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -L</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/main/website/docs/cluster-admin/cleaning-cluster-nodes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/rancher-docusaurus/cluster-admin/certificate-rotation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Certificate Rotation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/rancher-docusaurus/cluster-admin/cloning-clusters"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cloning Clusters Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-gets-removed" class="table-of-contents__link">What Gets Removed?</a></li><li><a href="#removing-a-node-from-a-cluster-by-rancher-ui" class="table-of-contents__link">Removing a Node from a Cluster by Rancher UI</a></li><li><a href="#removing-rancher-components-from-a-cluster-manually" class="table-of-contents__link">Removing Rancher Components from a Cluster Manually</a><ul><li><a href="#removing-rancher-components-from-registered-clusters" class="table-of-contents__link">Removing Rancher Components from Registered Clusters</a></li><li><a href="#windows-nodes" class="table-of-contents__link">Windows Nodes</a></li><li><a href="#docker-containers-images-and-volumes" class="table-of-contents__link">Docker Containers, Images, and Volumes</a></li><li><a href="#mounts" class="table-of-contents__link">Mounts</a></li><li><a href="#directories-and-files" class="table-of-contents__link">Directories and Files</a></li><li><a href="#network-interfaces-and-iptables" class="table-of-contents__link">Network Interfaces and Iptables</a></li><li><a href="#network-interfaces" class="table-of-contents__link">Network Interfaces</a></li><li><a href="#iptables" class="table-of-contents__link">Iptables</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://forums.rancher.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forums<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://slack.rancher.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Rancher_Labs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://rancher.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Rancher Website</a></li><li class="footer__item"><a href="https://github.com/rancher/rancher" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Rancher on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/rancher/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Rancher Docs on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/rancher-docusaurus/assets/js/runtime~main.9668cced.js"></script>
<script src="/rancher-docusaurus/assets/js/main.7243044c.js"></script>
</body>
</html>