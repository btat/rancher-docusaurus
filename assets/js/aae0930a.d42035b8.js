"use strict";(self.webpackChunkrancher_docusaurus=self.webpackChunkrancher_docusaurus||[]).push([[6751],{3905:function(e,t,r){r.d(t,{Zo:function(){return u},kt:function(){return m}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},c=Object.keys(e);for(n=0;n<c.length;n++)r=c[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(n=0;n<c.length;n++)r=c[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var o=n.createContext({}),l=function(e){var t=n.useContext(o),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},u=function(e){var t=l(e.components);return n.createElement(o.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,c=e.originalType,o=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),h=l(r),m=a,d=h["".concat(o,".").concat(m)]||h[m]||p[m]||c;return r?n.createElement(d,s(s({ref:t},u),{},{components:r})):n.createElement(d,s({ref:t},u))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var c=r.length,s=new Array(c);s[0]=h;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var l=2;l<c;l++)s[l]=r[l];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},2545:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return i},contentTitle:function(){return o},metadata:function(){return l},toc:function(){return u},default:function(){return h}});var n=r(7462),a=r(3366),c=(r(7294),r(3905)),s=["components"],i={title:"Migrating Rancher to a New Cluster",position:3},o=void 0,l={unversionedId:"backups/migrating-rancher",id:"backups/migrating-rancher",isDocsHomePage:!1,title:"Migrating Rancher to a New Cluster",description:"If you are migrating Rancher to a new Kubernetes cluster, you don't need to install Rancher on the new cluster first. If Rancher is restored to a new cluster with Rancher already installed, it can cause problems.",source:"@site/docs/backups/migrating-rancher.md",sourceDirName:"backups",slug:"/backups/migrating-rancher",permalink:"/rancher-docusaurus/backups/migrating-rancher",editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/backups/migrating-rancher.md",tags:[],version:"current",frontMatter:{title:"Migrating Rancher to a New Cluster",position:3},sidebar:"tutorialSidebar",previous:{title:"Intro",permalink:"/rancher-docusaurus/backups/index"},next:{title:"Restoring Rancher",permalink:"/rancher-docusaurus/backups/restoring-rancher"}},u=[{value:"Prerequisites",id:"prerequisites",children:[]},{value:"1. Install the rancher-backup Helm chart",id:"1-install-the-rancher-backup-helm-chart",children:[]},{value:"2. Restore from backup using a Restore custom resource",id:"2-restore-from-backup-using-a-restore-custom-resource",children:[]},{value:"3. Install cert-manager",id:"3-install-cert-manager",children:[]},{value:"4. Bring up Rancher with Helm",id:"4-bring-up-rancher-with-helm",children:[]}],p={toc:u};function h(e){var t=e.components,r=(0,a.Z)(e,s);return(0,c.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,c.kt)("p",null,"If you are migrating Rancher to a new Kubernetes cluster, you don't need to install Rancher on the new cluster first. If Rancher is restored to a new cluster with Rancher already installed, it can cause problems."),(0,c.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,c.kt)("p",null,"These instructions assume you have ",(0,c.kt)("a",{parentName:"p",href:"../back-up-rancher"},"created a backup")," and you have already installed a new Kubernetes cluster where Rancher will be deployed."),(0,c.kt)("p",null,"It is required to use the same hostname that was set as the server URL in the first cluster."),(0,c.kt)("p",null,"Rancher version must be v2.5.0 and up"),(0,c.kt)("p",null,"Rancher can be installed on any Kubernetes cluster, including hosted Kubernetes clusters such as Amazon EKS clusters. For help installing Kubernetes, refer to the documentation of the Kubernetes distribution. One of Rancher's Kubernetes distributions may also be used:"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("a",{parentName:"li",href:"https://rancher.com/docs/rke/latest/en/installation/"},"RKE Kubernetes installation docs")),(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("a",{parentName:"li",href:"https://rancher.com/docs/k3s/latest/en/installation/"},"K3s Kubernetes installation docs"))),(0,c.kt)("h3",{id:"1-install-the-rancher-backup-helm-chart"},"1. Install the rancher-backup Helm chart"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre"},"helm repo add rancher-charts https://charts.rancher.io\nhelm repo update\nhelm install rancher-backup-crd rancher-charts/rancher-backup-crd -n cattle-resources-system --create-namespace\nhelm install rancher-backup rancher-charts/rancher-backup -n cattle-resources-system\n")),(0,c.kt)("h3",{id:"2-restore-from-backup-using-a-restore-custom-resource"},"2. Restore from backup using a Restore custom resource"),(0,c.kt)("p",null,"If you are using an S3 store as the backup source, and need to use your S3 credentials for restore, create a secret in this cluster using your S3 credentials. The Secret data must have two keys, ",(0,c.kt)("inlineCode",{parentName:"p"},"accessKey")," and ",(0,c.kt)("inlineCode",{parentName:"p"},"secretKey")," containing the s3 credentials like this:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Secret\nmetadata:\n  name: s3-creds\ntype: Opaque\nstringData:\n  accessKey: \\<Enter your access key\\>\n  secretKey: \\<Enter your secret key\\>\n")),(0,c.kt)("p",null,"This secret can be created in any namespace, with the above example it will get created in the default namespace"),(0,c.kt)("p",null,"In the Restore custom resource, ",(0,c.kt)("inlineCode",{parentName:"p"},"prune")," must be set to false. "),(0,c.kt)("p",null,"Create a Restore custom resource like the example below:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-yaml"},"# migrationResource.yaml\napiVersion: resources.cattle.io/v1\nkind: Restore\nmetadata:\n  name: restore-migration\nspec:\n  backupFilename: backup-b0450532-cee1-4aa1-a881-f5f48a007b1c-2020-09-15T07-27-09Z.tar.gz\n  prune: false\n  encryptionConfigSecretName: encryptionconfig\n  storageLocation:\n    s3:\n      credentialSecretName: s3-creds\n      credentialSecretNamespace: default\n      bucketName: backup-test\n      folder: ecm1\n      region: us-west-2\n      endpoint: s3.us-west-2.amazonaws.com\n")),(0,c.kt)("p",null,">"," ",(0,c.kt)("strong",{parentName:"p"},"Important:")," The field ",(0,c.kt)("inlineCode",{parentName:"p"},"encryptionConfigSecretName")," must be set only if your backup was created with encryption enabled. Provide the name of the Secret containing the encryption config file. If you only have the encryption config file, but don't have a secret created with it in this cluster, use the following steps to create the secret:  "),(0,c.kt)("ol",null,(0,c.kt)("li",{parentName:"ol"},"The encryption configuration file must be named ",(0,c.kt)("inlineCode",{parentName:"li"},"encryption-provider-config.yaml"),", and the ",(0,c.kt)("inlineCode",{parentName:"li"},"--from-file")," flag must be used to create this secret. So save your ",(0,c.kt)("inlineCode",{parentName:"li"},"EncryptionConfiguration")," in a file called ",(0,c.kt)("inlineCode",{parentName:"li"},"encryption-provider-config.yaml")," and run this command:")),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre"},"kubectl create secret generic encryptionconfig \\\n  --from-file=./encryption-provider-config.yaml \\\n  -n cattle-resources-system\n")),(0,c.kt)("p",null,"Then apply the resource:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre"},"kubectl apply -f migrationResource.yaml \n")),(0,c.kt)("h3",{id:"3-install-cert-manager"},"3. Install cert-manager"),(0,c.kt)("p",null,"Follow the steps to ",(0,c.kt)("a",{parentName:"p",href:"https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/#5-install-cert-manager"},"install cert-manager")," in the documentation about installing cert-manager on Kubernetes."),(0,c.kt)("h3",{id:"4-bring-up-rancher-with-helm"},"4. Bring up Rancher with Helm"),(0,c.kt)("p",null,"Use the same version of Helm to install Rancher, that was used on the first cluster."),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre"},"helm install rancher rancher-latest/rancher \\\n  --namespace cattle-system \\\n  --set hostname=\\<same hostname as the server URL from the first Rancher server\\> \\\n")))}h.isMDXComponent=!0}}]);